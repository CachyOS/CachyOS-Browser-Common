From 058054ef4648971a4cf72fa5f42553786df7336a Mon Sep 17 00:00:00 2001
From: ohfp <1813007-ohfp@users.noreply.gitlab.com>
Date: Tue, 12 Apr 2022 11:57:53 +0200
Subject: [PATCH] port pref-pane patch changes to gecko-dev

fix xorigin pref init and handling

[LW] Ask to Restart Browser if Sync Pref in LW Settings is changed
---
 browser/components/preferences/jar.mn         |   1 +
 .../preferences/cachy-browser.inc.xhtml           | 254 ++++++++++++++++
 browser/components/preferences/cachy-browser.js   | 287 ++++++++++++++++++
 browser/components/preferences/preferences.js |   2 +
 .../components/preferences/preferences.xhtml  |  13 +
 .../en-US/browser/preferences/preferences.ftl |  95 ++++++
 browser/themes/shared/jar.inc.mn              |   2 +
 .../shared/preferences/category-cachy-browser.svg |  96 ++++++
 .../themes/shared/preferences/cachy-browser.css   |  23 ++
 .../themes/shared/preferences/preferences.css |   4 +
 10 files changed, 777 insertions(+)
 create mode 100644 browser/components/preferences/cachy-browser.inc.xhtml
 create mode 100644 browser/components/preferences/cachy-browser.js
 create mode 100644 browser/themes/shared/preferences/category-cachy-browser.svg
 create mode 100644 browser/themes/shared/preferences/cachy-browser.css

diff --git a/browser/components/preferences/jar.mn b/browser/components/preferences/jar.mn
index 2131a15ceef7..0b97dc14b42e 100644
--- a/browser/components/preferences/jar.mn
+++ b/browser/components/preferences/jar.mn
@@ -11,6 +11,7 @@ browser.jar:
    content/browser/preferences/home.js
    content/browser/preferences/search.js
    content/browser/preferences/privacy.js
+   content/browser/preferences/cachy-browser.js
    content/browser/preferences/containers.js
    content/browser/preferences/sync.js
    content/browser/preferences/experimental.js
diff --git a/browser/components/preferences/cachy-browser.inc.xhtml b/browser/components/preferences/cachy-browser.inc.xhtml
new file mode 100644
index 000000000000..c2dfea6d0858
--- /dev/null
+++ b/browser/components/preferences/cachy-browser.inc.xhtml
@@ -0,0 +1,254 @@
+# This Source Code Form is subject to the terms of the Mozilla Public
+# License, v. 2.0. If a copy of the MPL was not distributed with this
+# file, You can obtain one at http://mozilla.org/MPL/2.0/.
+
+<script src="chrome://browser/content/preferences/cachy-browser.js"/>
+
+<html:template id="template-paneCachy">
+
+<hbox class="subcategory" hidden="true" data-category="paneCachy">
+  <html:h1 data-l10n-id="cachy-browser-header"/>
+</hbox>
+
+<groupbox hidden="true" data-category="paneCachy">
+  <html:h2 data-l10n-id="cachy-browser-general-heading"/>
+
+  <!-- TEMPLATE FOR A NEW PREFERENCE
+  <hbox>
+    <checkbox id="cachy-browser-LABEL-checkbox" data-l10n-id="cachy-browser-LABEL-checkbox" preference="PREF" flex="1" />
+    <html:label for="cachy-browser-LABEL-collapse" class="sidebar-footer-link" pack="end"> <image class="sidebar-footer-icon help-icon"/> </html:label>
+  </hbox>
+  <vbox class="cachy-browser-collapse indent">
+    <html:input type="checkbox" id="cachy-browser-LABEL-collapse" />
+    <vbox class="cachy-browser-collapsed tracking-protection-ui content-blocking-category">
+      <label data-l10n-id="cachy-browser-LABEL-description" />
+      <html:div> <image src="chrome://browser/skin/warning.svg" /> <label data-l10n-id="cachy-browser-LABEL-warning1" class="cachy-browser-warning" /> </html:div>
+      <checkbox preference="PREF" label="PREF" />
+    </vbox>
+  </vbox>
+  -->
+
+  <hbox>
+    <checkbox id="cachy-browser-extension-update-checkbox" data-l10n-id="cachy-browser-extension-update-checkbox" preference="extensions.update.autoUpdateDefault" flex="1" />
+    <html:label for="cachy-browser-extension-update-collapse" class="sidebar-footer-link" pack="end"> <image class="sidebar-footer-icon help-icon"/> </html:label>
+  </hbox>
+  <vbox class="cachy-browser-collapse indent">
+    <html:input type="checkbox" id="cachy-browser-extension-update-collapse" />
+    <vbox class="cachy-browser-collapsed tracking-protection-ui content-blocking-category">
+      <label data-l10n-id="cachy-browser-extension-update-description" />
+      <html:div> <image src="chrome://browser/skin/warning.svg" /> <label data-l10n-id="cachy-browser-extension-update-warning1" class="cachy-browser-warning" /> </html:div>
+      <checkbox preference="extensions.update.autoUpdateDefault" label="extensions.update.autoUpdateDefault" />
+      <checkbox preference="extensions.update.enabled" label="extensions.update.enabled" />
+    </vbox>
+  </vbox>
+
+  <hbox>
+    <checkbox id="cachy-browser-sync-checkbox" data-l10n-id="cachy-browser-sync-checkbox" preference="identity.fxaccounts.enabled" flex="1" />
+    <html:label for="cachy-browser-sync-collapse" class="sidebar-footer-link" pack="end"> <image class="sidebar-footer-icon help-icon"/> </html:label>
+  </hbox>
+  <vbox class="cachy-browser-collapse indent">
+    <html:input type="checkbox" id="cachy-browser-sync-collapse" />
+    <vbox class="cachy-browser-collapsed tracking-protection-ui content-blocking-category">
+      <label data-l10n-id="cachy-browser-sync-description" />
+      <html:div> <image src="chrome://browser/skin/warning.svg" /> <label data-l10n-id="cachy-browser-sync-warning1" class="cachy-browser-warning" /> </html:div>
+      <checkbox preference="identity.fxaccounts.enabled" label="identity.fxaccounts.enabled" />
+    </vbox>
+  </vbox>
+  
+  <hbox>
+    <checkbox id="cachy-browser-autocopy-checkbox" data-l10n-id="cachy-browser-autocopy-checkbox" preference="clipboard.autocopy" flex="1" />
+    <html:label for="cachy-browser-autocopy-collapse" class="sidebar-footer-link" pack="end"> <image class="sidebar-footer-icon help-icon"/> </html:label>
+  </hbox>
+  <vbox class="cachy-browser-collapse indent">
+    <html:input type="checkbox" id="cachy-browser-autocopy-collapse" />
+    <vbox class="cachy-browser-collapsed tracking-protection-ui content-blocking-category">
+      <label data-l10n-id="cachy-browser-autocopy-description" />
+      <checkbox preference="clipboard.autocopy" label="clipboard.autocopy" />
+      <checkbox preference="middlemouse.paste" label="middlemouse.paste" />
+    </vbox>
+  </vbox>
+
+  <hbox>
+    <checkbox id="cachy-browser-styling-checkbox" data-l10n-id="cachy-browser-styling-checkbox" preference="toolkit.legacyUserProfileCustomizations.stylesheets" flex="1" />
+    <html:label for="cachy-browser-styling-collapse" class="sidebar-footer-link" pack="end"> <image class="sidebar-footer-icon help-icon"/> </html:label>
+  </hbox>
+  <vbox class="cachy-browser-collapse indent">
+    <html:input type="checkbox" id="cachy-browser-styling-collapse" />
+    <vbox class="cachy-browser-collapsed tracking-protection-ui content-blocking-category">
+      <label data-l10n-id="cachy-browser-styling-description" />
+      <html:div> <image src="chrome://browser/skin/warning.svg" /> <label data-l10n-id="cachy-browser-styling-warning1" class="cachy-browser-warning" /> </html:div>
+      <checkbox preference="toolkit.legacyUserProfileCustomizations.stylesheets" label="toolkit.legacyUserProfileCustomizations.stylesheets" />
+    </vbox>
+  </vbox>
+
+</groupbox>
+
+<groupbox hidden="true" data-category="paneCachy">
+  <html:h2 data-l10n-id="cachy-browser-network-heading" />
+
+  <hbox>
+    <checkbox id="cachy-browser-ipv6-checkbox" data-l10n-id="cachy-browser-ipv6-checkbox" preference="network.dns.disableIPv6" flex="1" />
+    <html:label for="cachy-browser-ipv6-collapse" class="sidebar-footer-link" pack="end"> <image class="sidebar-footer-icon help-icon"/> </html:label>
+  </hbox>
+  <vbox class="cachy-browser-collapse indent">
+    <html:input type="checkbox" id="cachy-browser-ipv6-collapse" />
+    <vbox class="cachy-browser-collapsed tracking-protection-ui content-blocking-category">
+      <label data-l10n-id="cachy-browser-ipv6-description" />
+      <html:div> <image src="chrome://browser/skin/warning.svg" /> <label data-l10n-id="cachy-browser-ipv6-warning1" class="cachy-browser-warning" /> </html:div>
+      <checkbox preference="network.dns.disableIPv6" label="network.dns.disableIPv6" />
+    </vbox>
+  </vbox>
+
+</groupbox>
+
+<groupbox hidden="true" data-category="paneCachy">
+  <html:h2 data-l10n-id="cachy-browser-privacy-heading" />
+
+  <hbox>
+    <checkbox id="cachy-browser-xorigin-ref-checkbox" data-l10n-id="cachy-browser-xorigin-ref-checkbox" preference="network.http.referer.XOriginPolicy" flex="1" />
+    <html:label for="cachy-browser-xorigin-ref-collapse" class="sidebar-footer-link" pack="end"> <image class="sidebar-footer-icon help-icon"/> </html:label>
+  </hbox>
+  <vbox class="cachy-browser-collapse indent">
+    <html:input type="checkbox" id="cachy-browser-xorigin-ref-collapse" />
+    <vbox class="cachy-browser-collapsed tracking-protection-ui content-blocking-category">
+      <label data-l10n-id="cachy-browser-xorigin-ref-description" />
+      <html:div> <image src="chrome://browser/skin/warning.svg" /> <label data-l10n-id="cachy-browser-xorigin-ref-warning1" class="cachy-browser-warning" /> </html:div>
+      <checkbox disabled="true" preference="network.http.referer.XOriginPolicy" label="network.http.referer.XOriginPolicy" />
+    </vbox>
+  </vbox>
+
+</groupbox>
+
+<groupbox hidden="true" data-category="paneCachy">
+  <html:h2 data-l10n-id="cachy-browser-broken-heading" />
+
+  <hbox>
+    <checkbox id="cachy-browser-rfp-checkbox" data-l10n-id="cachy-browser-rfp-checkbox" preference="privacy.resistFingerprinting" flex="1" />
+    <html:label for="cachy-browser-rfp-collapse" class="sidebar-footer-link" pack="end"> <image class="sidebar-footer-icon help-icon"/> </html:label>
+  </hbox>
+  <vbox class="cachy-browser-collapse indent">
+    <html:input type="checkbox" id="cachy-browser-rfp-collapse" />
+    <vbox class="cachy-browser-collapsed tracking-protection-ui content-blocking-category">
+      <label data-l10n-id="cachy-browser-rfp-description" />
+      <html:div> <image src="chrome://browser/skin/warning.svg" /> <label data-l10n-id="cachy-browser-rfp-warning1" class="cachy-browser-warning" /> </html:div>
+      <checkbox preference="privacy.resistFingerprinting" label="privacy.resistFingerprinting" />
+    </vbox>
+  </vbox>
+
+  <vbox class="indent">
+
+    <hbox>
+      <checkbox id="cachy-browser-letterboxing-checkbox" data-l10n-id="cachy-browser-letterboxing-checkbox" preference="privacy.resistFingerprinting.letterboxing" flex="1" />
+      <html:label for="cachy-browser-letterboxing-collapse" class="sidebar-footer-link" pack="end"> <image class="sidebar-footer-icon help-icon"/> </html:label>
+    </hbox>
+    <vbox class="cachy-browser-collapse indent">
+      <html:input type="checkbox" id="cachy-browser-letterboxing-collapse" />
+      <vbox class="cachy-browser-collapsed tracking-protection-ui content-blocking-category">
+        <label data-l10n-id="cachy-browser-letterboxing-description" />
+        <checkbox preference="privacy.resistFingerprinting.letterboxing" label="privacy.resistFingerprinting.letterboxing" />
+      </vbox>
+    </vbox>
+
+    <hbox>
+      <checkbox id="cachy-browser-auto-decline-canvas-checkbox" data-l10n-id="cachy-browser-auto-decline-canvas-checkbox" preference="privacy.resistFingerprinting.autoDeclineNoUserInputCanvasPrompts" flex="1" />
+      <html:label for="cachy-browser-auto-decline-canvas-collapse" class="sidebar-footer-link" pack="end"> <image class="sidebar-footer-icon help-icon"/> </html:label>
+    </hbox>
+    <vbox class="cachy-browser-collapse indent">
+      <html:input type="checkbox" id="cachy-browser-auto-decline-canvas-collapse" />
+      <vbox class="cachy-browser-collapsed tracking-protection-ui content-blocking-category">
+        <label data-l10n-id="cachy-browser-auto-decline-canvas-description" />
+        <html:div> <label data-l10n-id="cachy-browser-auto-decline-canvas-warning1" class="cachy-browser-warning" /> </html:div>
+        <checkbox preference="privacy.resistFingerprinting.autoDeclineNoUserInputCanvasPrompts" label="privacy.resistFingerprinting.autoDeclineNoUserInputCanvasPrompts" />
+      </vbox>
+    </vbox>
+
+  </vbox>
+
+  <hbox>
+    <checkbox id="cachy-browser-webgl-checkbox" data-l10n-id="cachy-browser-webgl-checkbox" preference="webgl.disabled" flex="1" />
+    <html:label for="cachy-browser-webgl-collapse" class="sidebar-footer-link" pack="end"> <image class="sidebar-footer-icon help-icon"/> </html:label>
+  </hbox>
+  <vbox class="cachy-browser-collapse indent">
+    <html:input type="checkbox" id="cachy-browser-webgl-collapse" />
+    <vbox class="cachy-browser-collapsed tracking-protection-ui content-blocking-category">
+      <label data-l10n-id="cachy-browser-webgl-description" />
+      <html:div> <image src="chrome://browser/skin/warning.svg" /> <label data-l10n-id="cachy-browser-webgl-warning1" class="cachy-browser-warning" /> </html:div>
+      <checkbox preference="webgl.disabled" label="webgl.disabled" />
+    </vbox>
+  </vbox>
+
+
+</groupbox>
+
+<groupbox hidden="true" data-category="paneCachy">
+  <html:h2 data-l10n-id="cachy-browser-security-heading" />
+
+  <hbox>
+    <checkbox id="cachy-browser-ocsp-checkbox" data-l10n-id="cachy-browser-ocsp-checkbox" preference="security.OCSP.require" flex="1" />
+    <html:label for="cachy-browser-ocsp-collapse" class="sidebar-footer-link" pack="end"> <image class="sidebar-footer-icon help-icon"/> </html:label>
+  </hbox>
+  <vbox class="cachy-browser-collapse indent">
+    <html:input type="checkbox" id="cachy-browser-ocsp-collapse" />
+    <vbox class="cachy-browser-collapsed tracking-protection-ui content-blocking-category">
+      <label data-l10n-id="cachy-browser-ocsp-description" />
+      <html:div> <image src="chrome://browser/skin/warning.svg" /> <label data-l10n-id="cachy-browser-ocsp-warning1" class="cachy-browser-warning" /> </html:div>
+      <checkbox preference="security.OCSP.require" label="security.OCSP.require" />
+    </vbox>
+  </vbox>
+
+  <hbox>
+    <checkbox id="cachy-browser-goog-safe-checkbox" data-l10n-id="cachy-browser-goog-safe-checkbox" preference="browser.safebrowsing.malware.enabled" flex="1" />
+    <html:label for="cachy-browser-goog-safe-collapse" class="sidebar-footer-link" pack="end"> <image class="sidebar-footer-icon help-icon"/> </html:label>
+  </hbox>
+  <vbox class="cachy-browser-collapse indent">
+    <html:input type="checkbox" id="cachy-browser-goog-safe-collapse" />
+    <vbox class="cachy-browser-collapsed tracking-protection-ui content-blocking-category">
+      <label data-l10n-id="cachy-browser-goog-safe-description" />
+      <html:div> <image src="chrome://browser/skin/warning.svg" /> <label data-l10n-id="cachy-browser-goog-safe-warning1" class="cachy-browser-warning" /> </html:div>
+      <checkbox preference="browser.safebrowsing.malware.enabled" label="browser.safebrowsing.malware.enabled" />
+      <checkbox preference="browser.safebrowsing.phishing.enabled" label="browser.safebrowsing.phishing.enabled" />
+      <checkbox preference="browser.safebrowsing.blockedURIs.enabled" label="browser.safebrowsing.blockedURIs.enabled" />
+      <checkbox preference="browser.safebrowsing.provider.google4.gethashURL" label="browser.safebrowsing.provider.google4.gethashURL" id="cachy-browser-goog-safe-hash4"/>
+      <checkbox preference="browser.safebrowsing.provider.google4.updateURL" label="browser.safebrowsing.provider.google4.updateURL" id="cachy-browser-goog-safe-up4"/>
+      <checkbox preference="browser.safebrowsing.provider.google.gethashURL" label="browser.safebrowsing.provider.google.gethashURL" id="cachy-browser-goog-safe-hash"/>
+      <checkbox preference="browser.safebrowsing.provider.google.updateURL" label="browser.safebrowsing.provider.google.updateURL" id="cachy-browser-goog-safe-up"/>
+    </vbox>
+  </vbox>
+
+  <vbox class="indent">
+    <hbox>
+      <checkbox id="cachy-browser-goog-safe-download-checkbox" data-l10n-id="cachy-browser-goog-safe-download-checkbox" preference="browser.safebrowsing.downloads.enabled" flex="1" />
+      <html:label for="cachy-browser-goog-safe-download-collapse" class="sidebar-footer-link" pack="end"> <image class="sidebar-footer-icon help-icon"/> </html:label>
+    </hbox>
+    <vbox class="cachy-browser-collapse indent">
+      <html:input type="checkbox" id="cachy-browser-goog-safe-download-collapse" />
+      <vbox class="cachy-browser-collapsed tracking-protection-ui content-blocking-category">
+        <label data-l10n-id="cachy-browser-goog-safe-download-description" />
+        <html:div> <image src="chrome://browser/skin/warning.svg" /> <label data-l10n-id="cachy-browser-goog-safe-download-warning1" class="cachy-browser-warning" /> </html:div>
+        <checkbox preference="browser.safebrowsing.downloads.enabled" label="browser.safebrowsing.downloads.enabled" />
+      </vbox>
+    </vbox>
+  </vbox>
+
+</groupbox>
+
+<hbox class="subcategory" hidden="true" data-category="paneCachy">
+    <html:h1 data-l10n-id="cachy-browser-footer"/>
+</hbox>
+
+<groupbox data-category="paneCachy" hidden="true">
+  <vbox align="start">
+    <hbox>
+      <button id="cachy-browser-config-link" is="highlightable-button" flex="1">
+        <image class="cachy-browser-button-icon" src="chrome://browser/skin/ion.svg" /> <!-- TODO not the typical way a picture is defined I think, and also we should copy the svg file in case they change it -->
+        <label data-l10n-id="cachy-browser-config-link"></label>
+      </button>
+      <button id="cachy-browser-open-profile" is="highlightable-button" flex="1">
+        <image class="cachy-browser-button-icon" src="chrome://browser/skin/open.svg" />
+        <label data-l10n-id="cachy-browser-open-profile"></label>
+      </button>
+    </hbox>
+  </vbox>
+</groupbox>
+
+</html:template>
diff --git a/browser/components/preferences/cachy-browser.js b/browser/components/preferences/cachy-browser.js
new file mode 100644
index 000000000000..c8cbb075d59b
--- /dev/null
+++ b/browser/components/preferences/cachy-browser.js
@@ -0,0 +1,287 @@
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,
+ * You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+/* import-globals-from extensionControlled.js */
+/* import-globals-from preferences.js */
+
+var { AppConstants } = ChromeUtils.import( "resource://gre/modules/AppConstants.jsm");
+XPCOMUtils.defineLazyGetter(this, "L10n", () => {
+  return new Localization([
+    "branding/brand.ftl",
+    "browser/preferences/preferences.ftl",
+  ]);
+});
+
+Preferences.addAll([
+  // IPv6
+  { id: "network.dns.disableIPv6", type: "bool" },
+  // ocsp hard-fail
+  { id: "security.OCSP.require", type: "bool" },
+  // ocsp hard-fail
+  { id: "identity.fxaccounts.enabled", type: "bool" },
+  // WebGL
+  { id: "webgl.disabled", type: "bool" },
+  // RFP
+  { id: "privacy.resistFingerprinting", type: "bool" },
+  // Automatically Update Extensions
+  { id: "extensions.update.enabled", type: "bool" },
+  { id: "extensions.update.autoUpdateDefault", type: "bool" },
+  // Clipboard autocopy/paste
+  { id: "clipboard.autocopy", type: "bool" },
+  { id: "middlemouse.paste", type: "bool" },
+  // XOrigin referrers
+  { id: "network.http.referer.XOriginPolicy", type: "int" },
+  // Harden
+  { id: "privacy.resistFingerprinting.letterboxing", type: "bool" },
+  // Google Safe Browsing
+  //{ id: "browser.safebrowsing.malware.enabled", type: "bool" }, // Already loaded
+  //{ id: "browser.safebrowsing.phishing.enabled", type: "bool" },
+  { id: "browser.safebrowsing.blockedURIs.enabled", type: "bool" },
+  { id: "browser.safebrowsing.provider.google4.gethashURL", type: "string" },
+  { id: "browser.safebrowsing.provider.google4.updateURL", type: "string" },
+  { id: "browser.safebrowsing.provider.google.gethashURL", type: "string" },
+  { id: "browser.safebrowsing.provider.google.updateURL", type: "string" },
+  /**** Prefs that require changing a lockPref ****/
+  // Google safe browsing check downloads
+  //{ id: "browser.safebrowsing.downloads.enabled", type: "bool" }, //Also already added
+  { id: "toolkit.legacyUserProfileCustomizations.stylesheets", type: "bool" },
+  // Canvas UI when blocked
+  {
+    id: "privacy.resistFingerprinting.autoDeclineNoUserInputCanvasPrompts",
+    type: "bool",
+  },
+]);
+
+var gCachyPane = {
+  _pane: null,
+
+  // called when the document is first parsed
+  init() {
+    this._pane = document.getElementById("paneCachy");
+
+    // Set all event listeners on checkboxes
+    setBoolSyncListeners(
+      "cachy-browser-extension-update-checkbox",
+      ["extensions.update.autoUpdateDefault", "extensions.update.enabled"],
+      [true,                                  true                       ],
+    );
+    setBoolSyncListeners(
+      "cachy-browser-ipv6-checkbox",
+      ["network.dns.disableIPv6"],
+      [false,                   ],
+    );
+    setBoolSyncListeners(
+      "cachy-browser-ocsp-checkbox",
+      ["security.OCSP.require"],
+      [true,                   ],
+    );
+    setBoolSyncListeners(
+      "cachy-browser-sync-checkbox",
+      ["identity.fxaccounts.enabled"],
+      [true,                   ],
+    );
+    setBoolSyncListeners(
+      "cachy-browser-autocopy-checkbox",
+      ["clipboard.autocopy", "middlemouse.paste"],
+      [true,                 true               ],
+    );
+    setBoolSyncListeners(
+      "cachy-browser-styling-checkbox",
+      ["toolkit.legacyUserProfileCustomizations.stylesheets"],
+      [true,                                                ],
+    );
+
+    setBoolSyncListeners(
+      "cachy-browser-webgl-checkbox",
+      ["webgl.disabled"],
+      [false           ],
+    );
+    setBoolSyncListeners(
+      "cachy-browser-rfp-checkbox",
+      ["privacy.resistFingerprinting"],
+      [true                          ],
+    );
+    setBoolSyncListeners(
+      "cachy-browser-auto-decline-canvas-checkbox",
+      ["privacy.resistFingerprinting.autoDeclineNoUserInputCanvasPrompts"],
+      [true                                      ],
+    );
+
+    setBoolSyncListeners(
+      "cachy-browser-letterboxing-checkbox",
+      ["privacy.resistFingerprinting.letterboxing"],
+      [true                                       ],
+    );
+
+    setSyncListeners(
+      "cachy-browser-goog-safe-checkbox",
+      [
+        "browser.safebrowsing.malware.enabled",
+        "browser.safebrowsing.phishing.enabled",
+        "browser.safebrowsing.blockedURIs.enabled",
+        "browser.safebrowsing.provider.google4.gethashURL",
+        "browser.safebrowsing.provider.google4.updateURL",
+        "browser.safebrowsing.provider.google.gethashURL",
+        "browser.safebrowsing.provider.google.updateURL",
+      ],
+      [
+        true,
+        true,
+        true,
+        "https://safebrowsing.googleapis.com/v4/fullHashes:find?$ct=application/x-protobuf&key=%GOOGLE_SAFEBROWSING_API_KEY%&$httpMethod=POST",
+        "https://safebrowsing.googleapis.com/v4/threatListUpdates:fetch?$ct=application/x-protobuf&key=%GOOGLE_SAFEBROWSING_API_KEY%&$httpMethod=POST",
+        "https://safebrowsing.google.com/safebrowsing/gethash?client=SAFEBROWSING_ID&appver=%MAJOR_VERSION%&pver=2.2",
+        "https://safebrowsing.google.com/safebrowsing/downloads?client=SAFEBROWSING_ID&appver=%MAJOR_VERSION%&pver=2.2&key=%GOOGLE_SAFEBROWSING_API_KEY%",
+      ],
+      [
+        false,
+        false,
+        false,
+        "",
+        "",
+        "",
+        "",
+      ]
+    );
+
+    setXOriginPolicySyncListeners(
+      "cachy-browser-xorigin-ref-checkbox",
+      "network.http.referer.XOriginPolicy",
+      [1, 2],
+      [0]
+    );
+
+    // Set event listener on open profile directory button
+    setEventListener("cachy-browser-open-profile", "command", openProfileDirectory);
+    // Set event listener on open about:config button
+    setEventListener("cachy-browser-config-link", "click", openAboutConfig);
+
+    // Notify observers that the UI is now ready
+    Services.obs.notifyObservers(window, "cachy-browser-pane-loaded");
+  },
+};
+
+function setXOriginPolicySyncListeners(checkboxid, pref, onVals, offVals) {
+  setSyncFromPrefListener(checkboxid, () => onVals.includes(getPref(pref)));
+  setSyncToPrefListener(checkboxid, () =>
+    writeGenericPrefs([pref], [2], [0], document.getElementById(checkboxid).checked)
+  );
+  Preferences.get(pref).on("change", () =>
+    makeMasterCheckboxesReactive(checkboxid, () =>
+      onVals.includes(getPref(pref))
+    )
+  );
+}
+
+function openProfileDirectory() {
+  // Get the profile directory.
+  let currProfD = Services.dirsvc.get("ProfD", Ci.nsIFile);
+  let profileDir = currProfD.path;
+
+  // Show the profile directory.
+  let nsLocalFile = Components.Constructor(
+    "@mozilla.org/file/local;1",
+    "nsIFile",
+    "initWithPath"
+  );
+  new nsLocalFile(profileDir).reveal();
+}
+
+function openAboutConfig() {
+  window.open("about:config", "_blank");
+}
+
+function setBoolSyncListeners(checkboxid, opts, vals) {
+  setSyncFromPrefListener(checkboxid, () => readGenericBoolPrefs(opts, vals));
+  setSyncToPrefListener(checkboxid, () => writeGenericBoolPrefs(opts, vals, document.getElementById(checkboxid).checked));
+  for (let i = 1; i < opts.length; i++) {
+    Preferences.get(opts[i]).on("change", () => makeMasterCheckboxesReactive(checkboxid, () => readGenericBoolPrefs(opts, vals)));
+  }
+}
+function setSyncListeners(checkboxid, opts, onVals, offVals) {
+  setSyncFromPrefListener(checkboxid, () => readGenericPrefs(opts, onVals, offVals));
+  setSyncToPrefListener(checkboxid, () => writeGenericPrefs(opts, onVals, offVals, document.getElementById(checkboxid).checked));
+  for (let i = 1; i < opts.length; i++) {
+    Preferences.get(opts[i]).on("change", () => makeMasterCheckboxesReactive(checkboxid, () => readGenericPrefs(opts, onVals, offVals)));
+  }
+}
+
+function makeMasterCheckboxesReactive(checkboxid, func) {
+  const shouldBeChecked = func();
+  document.getElementById(checkboxid).checked = shouldBeChecked;
+}
+
+// Wrapper function in case something more is required (as I suspected in the first iteration of this)
+function getPref(pref) {
+  const retval = Preferences.get(pref);
+/*  if (retval === undefined) {
+    return defaultValue;
+  } */
+  return retval._value;
+}
+// Returns true if all the preferences in prefs are equal to onVals, false otherwise TODO may need a third array for their default values because mozilla is dumb, after testing though pretty sure this was misinformation being spread by comments in default FF code that has long since been fixed
+function readGenericBoolPrefs(prefs, onVals) {
+  for (let i = 0; i < prefs.length; i++) {
+    if (getPref(prefs[i]) != onVals[i]) {
+      return false;
+    }
+  }
+  return true;
+}
+function writeGenericBoolPrefs(opts, vals, changeToOn) {
+  valsCopy = [...vals];
+  if (!changeToOn) {
+    for (let i = 0; i < vals.length; i++) {
+      valsCopy[i] = !vals[i];
+    }
+  }
+  // Start at 1 because returning sets the last one
+  for (let i = 1; i < vals.length; i++) {
+    Services.prefs.setBoolPref(opts[i], valsCopy[i]);
+  }
+  return valsCopy[0];
+}
+
+// Returns true if all the preferences in prefs are equal to onVals, false otherwise... currently the same as for Bool as offVals is ignored
+function readGenericPrefs(prefs, onVals, offVals) {
+  for (let i = 0; i < prefs.length; i ++) {
+    let temp = getPref(prefs[i]);
+    if (getPref(prefs[i]) != onVals[i]) {
+      return false;
+    }
+  }
+  return true;
+}
+function writeGenericPrefs(opts, onVals, offVals, changeToOn) {
+  let writeArr = (changeToOn) ? onVals : offVals;
+  for (let i = 1; i < opts.length; i++) {
+    let type = typeof(writeArr[i]);
+    if (type == "number") {
+      Services.prefs.setIntPref(opts[i], writeArr[i]);
+    } else if (type == "boolean") {
+      Services.prefs.setBoolPref(opts[i], writeArr[i]);
+    } else if (type == "string") {
+      Services.prefs.setCharPref(opts[i], writeArr[i]);
+    } else {
+      console.log("BADNESS 10000");
+    }
+  }
+  return writeArr[0];
+}
+
+Preferences.get("identity.fxaccounts.enabled").on("change", () => {
+  confirmRestartPrompt(
+    Services.prefs.getBoolPref("identity.fxaccounts.enabled"), // Restart is required to *enable* / *disable* the pref
+    1, // Default Button Index
+    true, // Cancel instead of Revert Button
+    false // No Restart Later button
+  ).then(buttonIndex => {
+    if (buttonIndex == CONFIRM_RESTART_PROMPT_RESTART_NOW) {
+      Services.startup.quit(
+        Ci.nsIAppStartup.eAttemptQuit | Ci.nsIAppStartup.eRestart
+      );
+      return;
+    }
+  });
+});
diff --git a/browser/components/preferences/preferences.js b/browser/components/preferences/preferences.js
index 19dda7cf39eb..f5e67b637b49 100644
--- a/browser/components/preferences/preferences.js
+++ b/browser/components/preferences/preferences.js
@@ -8,6 +8,7 @@
 /* import-globals-from search.js */
 /* import-globals-from containers.js */
 /* import-globals-from privacy.js */
+/* import-globals-from cachy-browser.js */
 /* import-globals-from sync.js */
 /* import-globals-from experimental.js */
 /* import-globals-from moreFromMozilla.js */
@@ -196,6 +197,7 @@ function init_all() {
   register_module("paneHome", gHomePane);
   register_module("paneSearch", gSearchPane);
   register_module("panePrivacy", gPrivacyPane);
+  register_module("paneCachy", gCachyPane);
   register_module("paneContainers", gContainersPane);
   if (Services.prefs.getBoolPref("browser.preferences.experimental")) {
     // Set hidden based on previous load's hidden value.
diff --git a/browser/components/preferences/preferences.xhtml b/browser/components/preferences/preferences.xhtml
index 6ee14eec9b2e..a0d768dce307 100644
--- a/browser/components/preferences/preferences.xhtml
+++ b/browser/components/preferences/preferences.xhtml
@@ -13,6 +13,7 @@
 <?xml-stylesheet href="chrome://browser/skin/preferences/search.css"?>
 <?xml-stylesheet href="chrome://browser/skin/preferences/containers.css"?>
 <?xml-stylesheet href="chrome://browser/skin/preferences/privacy.css"?>
+<?xml-stylesheet href="chrome://browser/skin/preferences/cachy-browser.css"?>
 
 <!DOCTYPE html>
 
@@ -129,6 +130,17 @@
           <label class="category-name" flex="1" data-l10n-id="pane-privacy-title"></label>
         </richlistitem>
 
+        <richlistitem id="category-cachy-browser"
+                      class="category"
+                      value="paneCachy"
+                      helpTopic="prefs-cachy-browser"
+                      data-l10n-id="category-cachy-browser"
+                      data-l10n-attrs="tooltiptext"
+                      align="center">
+          <image class="category-icon"/>
+          <label class="category-name" flex="1" data-l10n-id="pane-cachy-browser-title"></label>
+        </richlistitem>
+
         <richlistitem id="category-sync"
                       class="category"
                       hidden="true"
@@ -207,6 +219,7 @@
 #include home.inc.xhtml
 #include search.inc.xhtml
 #include privacy.inc.xhtml
+#include cachy-browser.inc.xhtml
 #include containers.inc.xhtml
 #include sync.inc.xhtml
 #include experimental.inc.xhtml
diff --git a/browser/locales/en-US/browser/preferences/preferences.ftl b/browser/locales/en-US/browser/preferences/preferences.ftl
index a1e414697e71..8eeb594ca17d 100644
--- a/browser/locales/en-US/browser/preferences/preferences.ftl
+++ b/browser/locales/en-US/browser/preferences/preferences.ftl
@@ -1420,3 +1420,98 @@ httpsonly-radio-disabled =
 desktop-folder-name = Desktop
 downloads-folder-name = Downloads
 choose-download-folder-title = Choose Download Folder:
+
+# Variables:
+#   $service-name (String) - Name of a cloud storage provider like Dropbox, Google Drive, etc...
+save-files-to-cloud-storage =
+    .label = Save files to { $service-name }
+
+## Cachy preferences
+
+# Sidebar
+pane-cachy-browser-title = Cachy
+category-cachy-browser =
+    .tooltiptext = about:config changes, logically grouped and easily accessible
+
+# Main content
+cachy-browser-header = Cachy Preferences
+cachy-browser-warning-title = Heads up!
+cachy-browser-warning-description = We carefully choose default settings to focus on privacy and security. When changing these settings, read the descriptions to understand the implications of those changes.
+
+# Page Layout
+cachy-browser-general-heading = Browser Behavior
+cachy-browser-extension-update-checkbox =
+    .label = Update add-ons automatically
+cachy-browser-sync-checkbox =
+    .label = Enable Firefox Sync
+cachy-browser-autocopy-checkbox =
+    .label = Enable middle click paste
+cachy-browser-styling-checkbox = 
+    .label = Allow userChrome.css customization
+
+cachy-browser-network-heading = Networking
+cachy-browser-ipv6-checkbox =
+    .label = Enable IPv6
+
+cachy-browser-privacy-heading = Privacy
+cachy-browser-xorigin-ref-checkbox =
+    .label = Limit cross-origin referrers
+
+cachy-browser-broken-heading = Fingerprinting
+cachy-browser-webgl-checkbox =
+    .label = Enable WebGL
+cachy-browser-rfp-checkbox =
+    .label = Enable ResistFingerprinting
+cachy-browser-auto-decline-canvas-checkbox =
+    .label = Silently block canvas access requests
+cachy-browser-letterboxing-checkbox =
+    .label = Enable letterboxing
+
+cachy-browser-security-heading = Security
+cachy-browser-ocsp-checkbox =
+    .label = Enforce OCSP hard-fail
+cachy-browser-goog-safe-checkbox =
+    .label = Enable Google Safe Browsing
+cachy-browser-goog-safe-download-checkbox =
+    .label = Scan downloads
+
+# In-depth descriptions
+cachy-browser-extension-update-description = Keep extensions up to date without manual intervention. A good choice for your security.
+cachy-browser-extension-update-warning1 = If you don't review the code of your extensions before every update, you should enable this option.
+
+cachy-browser-ipv6-description = Allow { -brand-short-name } to connect using IPv6.
+cachy-browser-ipv6-warning1 = Instead of blocking IPv6 in the browser, we suggest enabling the IPv6 privacy extension in your OS.
+cachy-browser-ocsp-description = Prevent connecting to a website if the OCSP check cannot be performed.
+cachy-browser-ocsp-warning1 = This increases security, but it will cause breakage when an OCSP server is down.
+cachy-browser-sync-description = Sync your data with other browsers. Requires restart.
+cachy-browser-sync-warning1 = Firefox Sync encrypts data locally before transmitting it to the server.
+
+cachy-browser-autocopy-description = Select some text to copy it, then paste it with a middle-mouse click.
+
+cachy-browser-styling-description = Enable this if you want to customize the UI with a manually loaded theme.
+cachy-browser-styling-warning1 = Make sure you trust the provider of the theme.
+
+cachy-browser-xorigin-ref-description = Send a referrer only on same-origin.
+cachy-browser-xorigin-ref-warning1 = This causes breakage. Additionally, even when sent referrers will still be trimmed.
+
+cachy-browser-webgl-description = WebGL is a strong fingerprinting vector.
+cachy-browser-webgl-warning1 = If you need to enable it, consider using an extension like Canvas Blocker.
+
+cachy-browser-rfp-description = ResistFingerprinting is the best in class anti-fingerprinting tool.
+cachy-browser-rfp-warning1 = If you need to disable it, consider using an extension like Canvas Blocker.
+
+cachy-browser-auto-decline-canvas-description = Automatically deny canvas access to websites, without prompting the user.
+cachy-browser-auto-decline-canvas-warning1 = It is still possible to allow canvas access from the urlbar.
+
+cachy-browser-letterboxing-description = Letterboxing applies margins around your windows, in order to return a limited set of rounded resolutions.
+
+cachy-browser-goog-safe-description = If you are worried about malware and phishing, consider enabling it.
+cachy-browser-goog-safe-warning1 = Disabled over censorship concerns but recommended for less advanced users. All the checks happen locally.
+
+cachy-browser-goog-safe-download-description = Allow Safe Browsing to scan your downloads to identify suspicious files.
+cachy-browser-goog-safe-download-warning1 = All the checks happen locally.
+
+# Footer
+cachy-browser-footer = Useful links
+cachy-browser-config-link = All advanced settings (about:config)
+cachy-browser-open-profile = Open user profile directory
diff --git a/browser/themes/shared/jar.inc.mn b/browser/themes/shared/jar.inc.mn
index 146764d56081..52326c00bdfe 100644
--- a/browser/themes/shared/jar.inc.mn
+++ b/browser/themes/shared/jar.inc.mn
@@ -108,6 +108,7 @@
   skin/classic/browser/preferences/android-menu.svg            (../shared/preferences/android-menu.svg)
   skin/classic/browser/preferences/category-general.svg        (../shared/preferences/category-general.svg)
   skin/classic/browser/preferences/category-privacy-security.svg    (../shared/preferences/category-privacy-security.svg)
+  skin/classic/browser/preferences/category-cachy-browser.svg    (../shared/preferences/category-cachy-browser.svg)
   skin/classic/browser/preferences/category-search.svg         (../shared/preferences/category-search.svg)
   skin/classic/browser/preferences/category-sync.svg           (../shared/preferences/category-sync.svg)
   skin/classic/browser/preferences/containers.css              (../shared/preferences/containers.css)
@@ -127,6 +128,7 @@
   skin/classic/browser/preferences/vpn-logo.svg                (../shared/preferences/vpn-logo.svg)
   skin/classic/browser/preferences/search.css                  (../shared/preferences/search.css)
   skin/classic/browser/preferences/siteDataSettings.css        (../shared/preferences/siteDataSettings.css)
+  skin/classic/browser/preferences/cachy-browser.css               (../shared/preferences/cachy-browser.css)
   skin/classic/browser/spotlight.css                           (../shared/spotlight.css)
   skin/classic/browser/upgradeDialog/abstract.png              (../shared/upgradeDialog/abstract.png)
   skin/classic/browser/upgradeDialog/cheers.png                (../shared/upgradeDialog/cheers.png)
diff --git a/browser/themes/shared/preferences/category-cachy-browser.svg b/browser/themes/shared/preferences/category-cachy-browser.svg
new file mode 100644
index 000000000000..8ebf2ebe19a9
--- /dev/null
+++ b/browser/themes/shared/preferences/category-cachy-browser.svg
@@ -0,0 +1,1 @@
+<svg width="67.733mm" height="67.733mm" version="1.1" viewBox="0 0 67.733 67.733" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><linearGradient id="linearGradient10237-3" x1="10.018" x2="202.29" y1="137.98" y2="137.98" gradientTransform="matrix(.52025 0 0 .52025 42.361 54.353)" gradientUnits="userSpaceOnUse"><stop stop-color="#1dc7b5" offset="0"/><stop stop-color="#1dc75e" offset="1"/></linearGradient><linearGradient id="linearGradient9232-6" x1="75.556" x2="201.92" y1="129.66" y2="129.66" gradientTransform="matrix(.52025 0 0 .52025 42.361 54.904)" gradientUnits="userSpaceOnUse" xlink:href="#linearGradient10042-7"/><linearGradient id="linearGradient10042-7"><stop offset="0"/><stop stop-color="#00786c" stop-opacity=".024256" offset="1"/></linearGradient><linearGradient id="linearGradient9304-5" x1="104.12" x2="200.52" y1="173.47" y2="173.47" gradientTransform="matrix(.52025 0 0 .52025 42.343 54.218)" gradientUnits="userSpaceOnUse" xlink:href="#linearGradient10042-7"/><linearGradient id="linearGradient10097-3" x1="104.12" x2="200.52" y1="173.47" y2="173.47" gradientTransform="matrix(.26013 .45055 -.45055 .26013 132.33 42.783)" gradientUnits="userSpaceOnUse" xlink:href="#linearGradient10042-7"/><linearGradient id="linearGradient10151-5" x1="104.12" x2="200.52" y1="173.47" y2="173.47" gradientTransform="matrix(-.26013 .45055 -.45055 -.26013 187.53 114.52)" gradientUnits="userSpaceOnUse" xlink:href="#linearGradient10042-7"/><linearGradient id="linearGradient10205-6" x1="104.12" x2="200.52" y1="173.47" y2="173.47" gradientTransform="matrix(-.52025 0 0 -.52025 152.57 198.17)" gradientUnits="userSpaceOnUse" xlink:href="#linearGradient10042-7"/><linearGradient id="linearGradient10228-2" x1="104.12" x2="200.52" y1="173.47" y2="173.47" gradientTransform="matrix(-.26013 -.45055 .45055 -.26013 62.753 210.02)" gradientUnits="userSpaceOnUse" xlink:href="#linearGradient10042-7"/></defs><g transform="translate(-42.107 -153.9)"><g transform="matrix(.58101 0 0 .58264 19.813 114.16)"><g><path d="m97.683 68.67-50.111 29.01v57.289l50.111 28.633 49.73-28.633 0.18673-57.289zm3.3885 37.3 15.826 13.562-3.7697 19.778-19.401 7.1582-15.262-13.562 3.3923-19.969z" fill="url(#linearGradient10237-3)"/><path d="m81.669 113.3c8.6225-30.419 46.593-27.762 65.744-15.259v57.455c-1.7984-47.198-34.12-53.048-46.529-49.166z" fill="url(#linearGradient9232-6)" opacity=".65932"/><path d="m101 105.99c30.734-7.4208 47.059 26.964 45.567 49.786l-50.056 28.205c40.237-24.737 29.466-55.767 19.993-64.673z" fill="url(#linearGradient9304-5)" opacity=".65932"/><path d="m116.83 119.47c21.794 22.906 0.17779 54.237-20.333 64.355l-49.454-29.247c41.541 22.478 63.029-2.365 66.005-15.022z" fill="url(#linearGradient10097-3)" opacity=".65932"/><path d="m113.36 139.43c-8.9406 30.327-46.881 27.272-65.9 14.569l0.60165-57.452c1.304 47.215 33.563 53.402 46.012 49.651z" fill="url(#linearGradient10151-5)" opacity=".65932"/><path d="m93.908 146.4c-30.734 7.4208-47.059-26.964-45.567-49.786l50.056-28.205c-40.237 24.737-29.466 55.767-19.993 64.673z" fill="url(#linearGradient10205-6)" opacity=".65932"/><path d="m78.256 133.33c-21.794-22.906-0.1778-54.237 20.333-64.355l49.454 29.247c-41.541-22.478-63.029 2.365-66.005 15.022z" fill="url(#linearGradient10228-2)" opacity=".65932"/></g><g fill="none"><path d="m81.863 112.9c5.865-24.419 36.656-31.721 65.751-15.205"/><path d="m101.08 105.96c24.08-7.1303 45.799 15.885 46.043 49.34"/><path d="m116.92 119.55c18.215 17.289 9.1429 47.605-19.708 64.545"/><path d="m113.13 139.32c-5.865 24.419-36.656 31.721-65.751 15.205"/><path d="m93.89 146.51c-24.08 7.1302-45.799-15.885-46.043-49.34"/><path d="m78.537 132.97c-18.215-17.289-9.1429-47.605 19.708-64.545"/></g></g></g></svg>
diff --git a/browser/themes/shared/preferences/cachy-browser.css b/browser/themes/shared/preferences/cachy-browser.css
new file mode 100644
index 000000000000..12f926ab7018
--- /dev/null
+++ b/browser/themes/shared/preferences/cachy-browser.css
@@ -0,0 +1,23 @@
+.cachy-browser-collapse > input {
+	display: none;
+}
+.cachy-browser-collapse > input ~ .cachy-browser-collapsed {
+	display: none;
+	/* max-height: 0; */
+	transition: max-height 0.25s ease-in-out;
+}
+.cachy-browser-collapse > input:checked ~ .cachy-browser-collapsed {
+	display: block;
+	/* max-height: 20rem; */
+}
+.cachy-browser-warning {
+	display: inline;
+	font-size: 0.8em;
+}
+.cachy-browser-button-icon {
+	width: 16px;
+	height: 16px;
+	margin-right: 8px;
+	-moz-context-properties: fill, fill-opacity;
+	fill: currentColor;
+}
diff --git a/browser/themes/shared/preferences/preferences.css b/browser/themes/shared/preferences/preferences.css
index 1968b68a1245..d0da141868e2 100644
--- a/browser/themes/shared/preferences/preferences.css
+++ b/browser/themes/shared/preferences/preferences.css
@@ -206,6 +206,10 @@ checkbox {
   list-style-image: url("chrome://browser/skin/preferences/category-privacy-security.svg");
 }
 
+#category-cachy-browser > .category-icon {
+  list-style-image: url("chrome://browser/skin/preferences/category-cachy-browser.svg");
+}
+
 #category-sync > .category-icon {
   list-style-image: url("chrome://browser/skin/preferences/category-sync.svg");
 }
-- 
2.37.3

